#!/usr/bin/bash

. ${HOME}/lib/set_env.sh
. ${HOME}/lib/common.sh

export L_SUPPORT_EMAILS="GIC_AnalyticsCoE_Architecture@AscenaRetail.com,Christian.Snediker-Morscheck@ascenaretail.com"

#Staging Status CHECK
options=" --quiet --format=csv --use_legacy_sql=false"


sql='
SELECT count(*) FROM edl_stage.bq_job_defn d
left join edl_stage.bq_job_status s
on d.bq_name = s.bqScriptName
and rundate = current_date
and runStatus = "Success"
where 
job_type = "Mart" and brand_cd = "PRE"
and s.bqScriptName is null
'
query='bq query $options $sql | awk "NR>1"'
eval result=\$\($query\)

if [ "$result" -ne 0 ]; then	
   echo "failure"    
   echo "Pre Mart load failed with " $result " bq scripts"
   echo $'There is a failure in Mart load\nPlease check edl_stage.bq_job_status for details.\n'$ERROR_MSG|mail -s "Do Not Reply - Failure in GCP Mart Load" ${L_SUPPORT_EMAILS}    
else
    echo "success"  
fi



