#!/usr/bin/bash
. ${HOME}/lib/set_env.sh
. ${HOME}/lib/common.sh

#Unique Key CHECK

sql='
select count(*) cnt
from
    (
    select
    orderid
    , lastmodifieddate
    , COALESCE(shippinggroupid,"")
    , COALESCE(shipitemrelshippinggroupid,"")
    , COALESCE(shipitemrelcommerceitemid,"")
    , COALESCE(shipitemrelquantity, "")
    , COALESCE(shipitemrelstate, "")
    , shippinggroupstate
    , lowbound
    , highbound
    , batch_id
    , count(*)
    from edl_stage.pre_atg_order_shipment
    group by 1,2,3,4,5,6,7,8,9,10,11
    having count(*)>1
)' 
	

run_validation "$sql" "Unique Key Check"

#completeness check 

sql='
SELECT
    count(*) cnt
from edl_landing.ann_ann_atg_transactions c
left join edl_stage.pre_atg_order_shipment w
    on  w.orderid = c.orderid
    and w.lastmodifieddate = PARSE_TIMESTAMP("%Y/%m/%d:%H:%M",c.lastmodifieddate)
    and COALESCE(w.shippinggroupid, "") = COALESCE(c.shippinggroupid, "")
    and COALESCE(w.shipitemrelcommerceitemid, "") = COALESCE(c.shipitemrelcommerceitemid,"")
    and w.batch_id=c.batch_id
where w.orderid is null
and c.orderid not like "%.orderid%" and c.relationshiptype != "payOrderRel"'

run_validation "$sql" "Completeness Check"


exit ${ERROR_CD:-0}
