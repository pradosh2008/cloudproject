#!/usr/bin/bash
. ${HOME}/lib/set_env.sh
. ${HOME}/lib/common.sh

#Unique Key CHECK

sql='
select count(*) cnt
from
    (
select
    orderid
    , lastmodifieddate
    , COALESCE(shipitemrelid,"") as shipitemrelid
    , shipitemrelshippinggroupid
    , shipitemrelcommerceitemid
     , COALESCE(trackingdetailtrackingnumber, "") as trackingdetailtrackingnumber
     , COALESCE(shippingcarrier, "") as shippingcarrier
     , COALESCE(shipmentdate, "") as shipmentdate
     , COALESCE(fullfilledlocation, "") as fullfilledlocation
     , COALESCE(shippedquantity, "") as shippedquantity
    , batch_id
    , count(*)
FROM edl_stage.pre_atg_order_shipment_tracking
GROUP BY 1,2,3,4,5,6,7,8,9,10,11 HAVING count(*)>1
)' 	

run_validation "$sql" "Unique Key Check"

#completeness check 

sql='
SELECT
    count(*) cnt
from edl_landing.ann_ann_atg_transactions c
left join edl_stage.pre_atg_order_shipment_tracking w
    on  w.orderid = c.orderid
    and w.lastmodifieddate = PARSE_TIMESTAMP("%Y/%m/%d:%H:%M",c.lastmodifieddate)
    and COALESCE(w.shipitemrelid, "") = COALESCE(c.shipitemrelid, "")
    and w.batch_id=c.batch_id
where w.orderid is null
and c.orderid not like "%.orderid%" 
and c.shipitemrelid IS NOT NULL '

run_validation "$sql" "Completeness Check"


exit ${ERROR_CD:-0}
