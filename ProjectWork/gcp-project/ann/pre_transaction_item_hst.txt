CREATE OR REPLACE TABLE analytic_mart.pre_transaction_item as
select
 FARM_FINGERPRINT(concat(replace(h.txn_nbr,':', '|'),'|',cast(i.txn_item_nbr as string))) as transaction_item_key
,FARM_FINGERPRINT(replace(h.txn_nbr,':', '|')) as transaction_key
,h.txn_nbr as transaction_num
,i.txn_item_nbr as line_num
,i.txn_source_cd as transaction_source_cd
,FARM_FINGERPRINT(cast(i.store_nbr as string)) as store_key
,i.register_nbr as register_num
,i.brand_cd as brand_cd
,EXTRACT(DATE FROM i.txn_dt) as transaction_dt
,EXTRACT(TIME FROM (i.txn_dt)) as transaction_tms
,i.txn_type_cd as transaction_type_cd
,i.txn_channel_cd as channel_cd
,p.sku as sku_id
,ROUND(i.item_list_price,2) as list_price_amt
,i.item_sold_qty as item_sold_qty
,ROUND(i.item_sold_price,2) as item_sold_amt
,ROUND(i.item_gross_amt,2) as item_gross_amt
,ROUND(i.item_disc_amt,2) as item_disc_amt
,ROUND(i.item_net_amt,2) as item_net_amt
,i.item_ret_from_txn_id as item_return_from_transaction_num
,i.item_ret_cd as item_return_cd
,i.item_ret_dt as item_return_dt
,i.item_ret_qty as item_return_qty
,ROUND(i.item_ret_amt,2) as item_return_amt
,i.full_price_flg as full_price_flg
,'20160101' as batch_id
from edl_stage.pre_hst_transaction_item i
inner join edl_stage.pre_hst_transaction_header h on i.txn_nbr =h.txn_nbr
and EXTRACT(DATE FROM h.txn_dt) between '2016-01-01' and '2019-05-04'
left outer join edl_stage.pre_lu_product_vw as p on i.product_id =p.product_id


CREATE OR REPLACE TABLE analytic_mart.pre_transaction_header
AS
select 
	 FARM_FINGERPRINT(replace(txn_nbr,':', '|')) as transaction_key
	,TXN_NBR as transaction_num
	,TXN_SOURCE_CD as transaction_source_cd
	,TXN_STATUS_CD as transaction_status_cd
	,FARM_FINGERPRINT(cast(STORE_NBR as string)) as store_key
	,REGISTER_NBR as register_num
	,BRAND_CD as brand_cd
	,EXTRACT(DATE FROM TXN_DT) as transaction_dt
	,EXTRACT(TIME FROM TXN_DT) as transaction_tms
	,TXN_TYPE_CD as transaction_type_cd
	,TXN_CHANNEL_CD as channel_cd 
	,ROUND(TXN_GROSS_AMT,2) as transaction_gross_amt
	,ROUND(TXN_NET_AMT,2) as transaction_net_amt
	,'20160101' as batch_id
from edl_stage.pre_hst_transaction_header 
where EXTRACT(DATE FROM txn_dt)  between '2016-01-01' and '2019-05-04'



CREATE OR REPLACE TABLE analytic_mart.pre_transaction_item_discount AS
SELECT
  FARM_FINGERPRINT(concat(replace(i.txn_nbr,':', '|'),'|',cast(i.txn_item_nbr as string),'|',cast(d.disc_seq_nbr as string))) as transaction_disc_key
 ,FARM_FINGERPRINT(replace(i.txn_nbr,':', '|')) as transaction_key
 ,i.txn_nbr as transaction_num
 ,i.txn_item_nbr as line_num
 ,d.disc_seq_nbr as discount_line_num
 ,d.brand_cd as brand_cd
 ,FARM_FINGERPRINT(cast(d.store_nbr as string)) as store_key
 ,EXTRACT(DATE FROM d.txn_dt) as transaction_dt
 ,d.txn_channel_cd as transaction_channel_cd
 ,d.disc_type_cd as discount_type_cd
 ,d.disc_serial_nbr as discount_serial_num
 ,ROUND(d.disc_amt,2) as discount_amt
 ,'20160101' as batch_id
FROM edl_stage.pre_hst_transaction_item_discount d
inner join edl_stage.pre_hst_transaction_item i on (d.txn_item_id = i.txn_item_id)
where EXTRACT(DATE FROM d.TXN_DT) between '2016-01-01' and '2019-05-04'

